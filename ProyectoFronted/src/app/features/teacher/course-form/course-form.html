<app-navbar></app-navbar>

<div class="course-form-page bg-light min-vh-100 py-5">
  <div class="container">
    <!-- Header -->
    <div class="mb-4">
      <div class="d-flex align-items-center gap-3 mb-3">
        <!-- CORRECCIÓN: Texto oculto para el botón Atrás -->
        <a routerLink="/teacher/my-courses" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left" aria-hidden="true"></i>
          <span class="visually-hidden">Volver a mis cursos</span>
        </a>
        <div>
          <h2 class="fw-bold mb-1">{{ isEditMode() ? 'Editar Curso' : 'Crear Nuevo Curso' }}</h2>
          <p class="text-muted mb-0">{{ isEditMode() ? 'Actualiza la información de tu curso' : 'Completa la información de tu curso' }}</p>
        </div>
      </div>
    </div>

    @if (isLoading()) {
      <div class="text-center py-5">
        <app-loading-spinner [size]="60" message="Cargando..."></app-loading-spinner>
      </div>
    } @else {
      <form [formGroup]="courseForm" (ngSubmit)="onSubmit()">
        <div class="row">
          <!-- Main Content -->
          <div class="col-lg-8">
            
            <!-- Step 1: Basic Information -->
            <div class="card-modern p-4 mb-4">
              <h5 class="fw-bold mb-4">
                <span class="badge bg-gradient me-2">1</span>
                Información Básica
              </h5>

              <!-- Title -->
              <div class="mb-3">
                <label for="title" class="form-label fw-semibold">Título del Curso *</label>
                <input 
                  type="text"
                  id="title"
                  class="form-control"
                  formControlName="title"
                  placeholder="Ej: Curso Completo de Angular"
                  [class.is-invalid]="isFieldInvalid('title')">
                @if (isFieldInvalid('title')) {
                  <div class="invalid-feedback">El título es obligatorio</div>
                }
              </div>

              <!-- Short Description -->
              <div class="mb-3">
                <label for="shortDescription" class="form-label fw-semibold">Descripción Corta *</label>
                <input 
                  type="text"
                  id="shortDescription"
                  class="form-control"
                  formControlName="shortDescription"
                  placeholder="Descripción breve que aparecerá en las tarjetas"
                  maxlength="150"
                  [class.is-invalid]="isFieldInvalid('shortDescription')">
                <small class="text-muted">{{ courseForm.get('shortDescription')?.value?.length || 0 }}/150 caracteres</small>
                @if (isFieldInvalid('shortDescription')) {
                  <div class="invalid-feedback">La descripción corta es obligatoria</div>
                }
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label for="description" class="form-label fw-semibold">Descripción Completa *</label>
                <textarea 
                  id="description"
                  class="form-control"
                  formControlName="description"
                  rows="6"
                  placeholder="Describe detalladamente de qué trata tu curso..."
                  [class.is-invalid]="isFieldInvalid('description')">
                </textarea>
                @if (isFieldInvalid('description')) {
                  <div class="invalid-feedback">La descripción es obligatoria</div>
                }
              </div>

              <!-- Category & Level -->
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="category" class="form-label fw-semibold">Categoría *</label>
                  <select 
                    id="category"
                    class="form-select"
                    formControlName="category"
                    [class.is-invalid]="isFieldInvalid('category')">
                    <option value="">Selecciona una categoría</option>
                    @for (cat of categories; track cat.value) {
                      <option [value]="cat.value">{{ cat.label }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('category')) {
                    <div class="invalid-feedback">La categoría es obligatoria</div>
                  }
                </div>

                <div class="col-md-6">
                  <label for="level" class="form-label fw-semibold">Nivel *</label>
                  <select 
                    id="level"
                    class="form-select"
                    formControlName="level"
                    [class.is-invalid]="isFieldInvalid('level')">
                    <option value="">Selecciona un nivel</option>
                    @for (level of levels; track level.value) {
                      <option [value]="level.value">{{ level.label }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('level')) {
                    <div class="invalid-feedback">El nivel es obligatorio</div>
                  }
                </div>
              </div>
            </div>

            <!-- Step 2: Learning Objectives -->
            <div class="card-modern p-4 mb-4">
              <h5 class="fw-bold mb-4">
                <span class="badge bg-gradient me-2">2</span>
                Objetivos de Aprendizaje
              </h5>

              <div formArrayName="learningObjectives">
                @for (objective of learningObjectives.controls; track $index) {
                  <div class="input-group mb-3">
                    <span class="input-group-text">
                      <i class="bi bi-check-circle" aria-hidden="true"></i>
                    </span>
                    <input 
                      type="text"
                      class="form-control"
                      [formControlName]="$index"
                      aria-label="Objetivo de aprendizaje"
                      placeholder="Ej: Aprenderás a crear aplicaciones web modernas">
                    
                    <!-- CORRECCIÓN: Texto oculto para eliminar objetivo -->
                    <button 
                      type="button"
                      class="btn btn-outline-danger"
                      (click)="removeObjective($index)">
                      <i class="bi bi-trash" aria-hidden="true"></i>
                      <span class="visually-hidden">Eliminar objetivo {{ $index + 1 }}</span>
                    </button>
                  </div>
                }
              </div>

              <button 
                type="button"
                class="btn btn-outline-primary btn-sm"
                (click)="addObjective()">
                <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>
                Agregar Objetivo
              </button>
            </div>

            <!-- Step 3: Requirements -->
            <div class="card-modern p-4 mb-4">
              <h5 class="fw-bold mb-4">
                <span class="badge bg-gradient me-2">3</span>
                Requisitos Previos
              </h5>

              <div formArrayName="requirements">
                @for (req of requirements.controls; track $index) {
                  <div class="input-group mb-3">
                    <span class="input-group-text">
                      <i class="bi bi-dot" aria-hidden="true"></i>
                    </span>
                    <input 
                      type="text"
                      class="form-control"
                      [formControlName]="$index"
                      aria-label="Requisito previo"
                      placeholder="Ej: Conocimientos básicos de HTML y CSS">
                    
                    <!-- CORRECCIÓN: Texto oculto para eliminar requisito -->
                    <button 
                      type="button"
                      class="btn btn-outline-danger"
                      (click)="removeRequirement($index)">
                      <i class="bi bi-trash" aria-hidden="true"></i>
                      <span class="visually-hidden">Eliminar requisito {{ $index + 1 }}</span>
                    </button>
                  </div>
                }
              </div>

              <button 
                type="button"
                class="btn btn-outline-primary btn-sm"
                (click)="addRequirement()">
                <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>
                Agregar Requisito
              </button>
            </div>

            <!-- Step 4: Course Content (Syllabus) -->
            <div class="card-modern p-4 mb-4">
              <h5 class="fw-bold mb-4">
                <span class="badge bg-gradient me-2">4</span>
                Contenido del Curso
              </h5>

              <div formArrayName="sections">
                @for (section of sections.controls; track $index) {
                  <div class="section-card card bg-light mb-3" [formGroupName]="$index">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0">Sección {{ $index + 1 }}</h6>
                        
                        <!-- CORRECCIÓN: Texto oculto para eliminar sección -->
                        <button 
                          type="button"
                          class="btn btn-sm btn-outline-danger"
                          (click)="removeSection($index)">
                          <i class="bi bi-trash" aria-hidden="true"></i>
                          <span class="visually-hidden">Eliminar sección {{ $index + 1 }}</span>
                        </button>
                      </div>

                      <!-- Section Title -->
                      <div class="mb-3">
                        <input 
                          type="text"
                          class="form-control"
                          formControlName="title"
                          aria-label="Título de la sección"
                          placeholder="Título de la sección">
                      </div>

                      <!-- Section Description -->
                      <div class="mb-3">
                        <textarea 
                          class="form-control"
                          formControlName="description"
                          rows="2"
                          aria-label="Descripción de la sección"
                          placeholder="Descripción de la sección (opcional)">
                        </textarea>
                      </div>

                      <!-- Lessons -->
                      <div formArrayName="lessons">
                        <p class="form-label small fw-semibold">Lecciones:</p>
                        @for (lesson of getLessons($index).controls; track $index; let lessonIndex = $index) {
                          <div class="input-group input-group-sm mb-2" [formGroupName]="lessonIndex">
                            <span class="input-group-text">
                              <i class="bi bi-play-circle" aria-hidden="true"></i>
                            </span>
                            <input 
                              type="text"
                              class="form-control"
                              formControlName="title"
                              placeholder="Título de la lección"
                              aria-label="Título de la lección">
                            
                            <!-- CORRECCIÓN: Clase .input-duration reemplaza style inline -->
                            <input 
                              type="number"
                              class="form-control input-duration"
                              formControlName="duration"
                              placeholder="Min"
                              aria-label="Duración en minutos">
                            
                            <!-- CORRECCIÓN: Texto oculto para eliminar lección -->
                            <button 
                              type="button"
                              class="btn btn-outline-danger"
                              (click)="removeLesson($index, lessonIndex)">
                              <i class="bi bi-x" aria-hidden="true"></i>
                              <span class="visually-hidden">Eliminar lección</span>
                            </button>
                          </div>
                        }
                      </div>

                      <button 
                        type="button"
                        class="btn btn-outline-secondary btn-sm mt-2"
                        (click)="addLesson($index)">
                        <i class="bi bi-plus me-1" aria-hidden="true"></i>
                        Agregar Lección
                      </button>
                    </div>
                  </div>
                }
              </div>

              <button 
                type="button"
                class="btn btn-outline-primary"
                (click)="addSection()">
                <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>
                Agregar Sección
              </button>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="col-lg-4">
            <!-- Pricing & Settings -->
            <!-- CORRECCIÓN: Clase .sidebar-sticky reemplaza style="top: 100px" -->
            <div class="card-modern p-4 mb-4 sidebar-sticky">
              <h5 class="fw-bold mb-4">Configuración</h5>

              <!-- Price -->
              <div class="mb-3">
                <label for="price" class="form-label fw-semibold">Precio (USD) *</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input 
                    type="number"
                    id="price"
                    class="form-control"
                    formControlName="price"
                    placeholder="0.00"
                    min="0"
                    step="0.01"
                    [class.is-invalid]="isFieldInvalid('price')">
                </div>
                <small class="text-muted">Usa 0 para cursos gratuitos</small>
                @if (isFieldInvalid('price')) {
                  <div class="invalid-feedback d-block">El precio es obligatorio</div>
                }
              </div>

              <!-- Thumbnail URL -->
              <div class="mb-3">
                <label for="thumbnail" class="form-label fw-semibold">URL de Imagen</label>
                <input 
                  type="url"
                  id="thumbnail"
                  class="form-control"
                  formControlName="thumbnail"
                  placeholder="https://ejemplo.com/imagen.jpg">
                <small class="text-muted">URL de la imagen del curso</small>
              </div>

              <!-- Preview -->
              @if (courseForm.get('thumbnail')?.value) {
                <div class="mb-3">
                  <img 
                    [src]="courseForm.get('thumbnail')?.value" 
                    class="img-fluid rounded"
                    alt=""
                    (error)="onImageError($event)">
                </div>
              }

              <!-- Checkboxes -->
              <div class="mb-3">
                <div class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="hasCertificate"
                    formControlName="hasCertificate">
                  <label class="form-check-label" for="hasCertificate">
                    Incluye certificado
                  </label>
                </div>
              </div>

              <div class="mb-4">
                <div class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="hasLiveClasses"
                    formControlName="hasLiveClasses">
                  <label class="form-check-label" for="hasLiveClasses">
                    Incluye clases en vivo
                  </label>
                </div>
              </div>

              <hr>

              <!-- Actions -->
              <div class="d-grid gap-2">
                @if (isEditMode()) {
                  <button 
                    type="submit"
                    class="btn btn-gradient"
                    [disabled]="isSaving() || courseForm.invalid">
                    @if (isSaving()) {
                      <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                      Guardando...
                    } @else {
                      <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                      Actualizar Curso
                    }
                  </button>
                } @else {
                  <button 
                    type="submit"
                    class="btn btn-gradient"
                    [disabled]="isSaving() || courseForm.invalid">
                    @if (isSaving()) {
                      <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                      Creando...
                    } @else {
                      <i class="bi bi-send me-2" aria-hidden="true"></i>
                      Publicar Curso
                    }
                  </button>
                  
                  <button 
                    type="button"
                    class="btn btn-outline-secondary"
                    (click)="saveDraft()"
                    [disabled]="isSaving()">
                    <i class="bi bi-save me-2" aria-hidden="true"></i>
                    Guardar Borrador
                  </button>
                }

                <a routerLink="/teacher/my-courses" class="btn btn-outline-danger">
                  Cancelar
                </a>
              </div>
            </div>
          </div>
        </div>
      </form>
    }
  </div>
</div>

<app-footer></app-footer>