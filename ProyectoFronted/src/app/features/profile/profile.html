<app-navbar></app-navbar>

<div class="profile-page bg-light min-vh-100 py-5">
  <div class="container">
    <div class="row">
      
      <!-- Sidebar -->
      <div class="col-lg-3 mb-4">
        <div class="card-modern p-4 text-center">
          
          <!-- Avatar Section -->
          <div class="position-relative d-inline-block mb-3">
            @if (userAvatar()) {
              <img 
                [src]="userAvatar()" 
                alt="" 
                class="rounded-circle avatar-img">
            } @else {
              <div class="avatar-placeholder rounded-circle bg-gradient mx-auto">
                <span class="text-white display-4">{{ fullName().charAt(0) }}</span>
              </div>
            }
            
            <button 
              type="button"
              class="btn btn-sm btn-gradient position-absolute bottom-0 end-0 rounded-circle btn-camera"
              aria-label="Cambiar foto de perfil">
              <i class="bi bi-camera" aria-hidden="true"></i>
            </button>
          </div>

          <h5 class="fw-bold mb-1">{{ fullName() }}</h5>
          <p class="text-muted mb-3">{{ userEmail() }}</p>
          <span class="badge badge-gradient">{{ getRoleLabel(userRole()) }}</span>

          <hr class="my-4">

          <!-- Navigation Menu -->
          <!-- CORRECCIÓN: Contenedor visual genérico -->
          <div class="d-grid gap-2">
            
            <!-- 1. Grupo Semántico de Pestañas (Solo Tabs aquí) -->
            <div role="tablist" aria-orientation="vertical" class="d-grid gap-2">
              <button 
                type="button"
                class="btn btn-outline-primary text-start"
                role="tab"
                [attr.aria-selected]="activeTab() === 'profile'"
                [class.active]="activeTab() === 'profile'"
                (click)="activeTab.set('profile')">
                <i class="bi bi-person me-2" aria-hidden="true"></i>
                Mi Perfil
              </button>
              
              <button 
                type="button"
                class="btn btn-outline-primary text-start"
                role="tab"
                [attr.aria-selected]="activeTab() === 'security'"
                [class.active]="activeTab() === 'security'"
                (click)="activeTab.set('security')">
                <i class="bi bi-shield-lock me-2" aria-hidden="true"></i>
                Seguridad
              </button>
              
              <button 
                type="button"
                class="btn btn-outline-primary text-start"
                role="tab"
                [attr.aria-selected]="activeTab() === 'preferences'"
                [class.active]="activeTab() === 'preferences'"
                (click)="activeTab.set('preferences')">
                <i class="bi bi-gear me-2" aria-hidden="true"></i>
                Preferencias
              </button>
            </div>
            
            <!-- 2. Elementos fuera del grupo de pestañas (Separador y Logout) -->
            <hr class="my-2">
            
            <button 
              type="button"
              class="btn btn-outline-danger text-start" 
              (click)="logout()">
              <i class="bi bi-box-arrow-right me-2" aria-hidden="true"></i>
              Cerrar Sesión
            </button>
          </div>

        </div>
      </div>

      <!-- Main Content -->
      <div class="col-lg-9">
        
        <!-- TAB: PROFILE -->
        @if (activeTab() === 'profile') {
          <div class="card-modern p-4 mb-4" role="tabpanel" tabindex="0">
            <h4 class="fw-bold mb-4">Información Personal</h4>

            <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="name" class="form-label fw-semibold">Nombre *</label>
                  <input 
                    type="text"
                    id="name"
                    class="form-control"
                    formControlName="name"
                    [class.is-invalid]="isFieldInvalid('name')">
                  @if (isFieldInvalid('name')) {
                    <div class="invalid-feedback">El nombre es obligatorio</div>
                  }
                </div>

                <div class="col-md-6">
                  <label for="surname" class="form-label fw-semibold">Apellido</label>
                  <input 
                    type="text"
                    id="surname"
                    class="form-control"
                    formControlName="surname">
                </div>

                <div class="col-md-6">
                  <label for="email" class="form-label fw-semibold">Email *</label>
                  <input 
                    type="email"
                    id="email"
                    class="form-control"
                    formControlName="email"
                    [class.is-invalid]="isFieldInvalid('email')">
                  @if (isFieldInvalid('email')) {
                    <div class="invalid-feedback">Email válido obligatorio</div>
                  }
                </div>

                <div class="col-md-6">
                  <label for="phoneNumber" class="form-label fw-semibold">Teléfono</label>
                  <input 
                    type="tel"
                    id="phoneNumber"
                    class="form-control"
                    formControlName="phoneNumber">
                </div>

                <div class="col-12">
                  <label for="biography" class="form-label fw-semibold">Biografía</label>
                  <textarea 
                    id="biography"
                    class="form-control"
                    formControlName="biography"
                    rows="4"
                    placeholder="Cuéntanos sobre ti...">
                  </textarea>
                </div>

                @if (userRole() === 'TEACHER') {
                  <div class="col-12">
                    <h6 class="fw-bold mt-3 mb-3">Redes Sociales</h6>
                  </div>

                  <div class="col-md-6">
                    <label for="linkedin" class="form-label">LinkedIn</label>
                    <input 
                      type="url"
                      id="linkedin"
                      class="form-control"
                      formControlName="linkedin"
                      placeholder="https://linkedin.com/in/...">
                  </div>

                  <div class="col-md-6">
                    <label for="twitter" class="form-label">Twitter</label>
                    <input 
                      type="url"
                      id="twitter"
                      class="form-control"
                      formControlName="twitter"
                      placeholder="https://twitter.com/...">
                  </div>

                  <div class="col-md-6">
                    <label for="website" class="form-label">Sitio Web</label>
                    <input 
                      type="url"
                      id="website"
                      class="form-control"
                      formControlName="website"
                      placeholder="https://...">
                  </div>
                }
              </div>

              <hr class="my-4">

              <div class="d-flex gap-2">
                <button 
                  type="submit"
                  class="btn btn-gradient"
                  [disabled]="isSaving() || profileForm.invalid">
                  @if (isSaving()) {
                    <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                    Guardando...
                  } @else {
                    <i class="bi bi-save me-2" aria-hidden="true"></i>
                    Guardar Cambios
                  }
                </button>
                <button 
                  type="button"
                  class="btn btn-outline-secondary"
                  (click)="resetForm()">
                  Cancelar
                </button>
              </div>
            </form>
          </div>
        }

        <!-- TAB: SECURITY -->
        @if (activeTab() === 'security') {
          <div class="card-modern p-4 mb-4" role="tabpanel" tabindex="0">
            <h4 class="fw-bold mb-4">Seguridad</h4>

            <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
              <div class="row g-3">
                <div class="col-12">
                  <label for="currentPassword" class="form-label fw-semibold">Contraseña Actual *</label>
                  <input 
                    type="password"
                    id="currentPassword"
                    class="form-control"
                    formControlName="currentPassword"
                    [class.is-invalid]="isPasswordFieldInvalid('currentPassword')">
                  @if (isPasswordFieldInvalid('currentPassword')) {
                    <div class="invalid-feedback">La contraseña actual es obligatoria</div>
                  }
                </div>

                <div class="col-md-6">
                  <label for="newPassword" class="form-label fw-semibold">Nueva Contraseña *</label>
                  <input 
                    type="password"
                    id="newPassword"
                    class="form-control"
                    formControlName="newPassword"
                    [class.is-invalid]="isPasswordFieldInvalid('newPassword')">
                  @if (isPasswordFieldInvalid('newPassword')) {
                    <div class="invalid-feedback">Mínimo 6 caracteres</div>
                  }
                </div>

                <div class="col-md-6">
                  <label for="confirmPassword" class="form-label fw-semibold">Confirmar Contraseña *</label>
                  <input 
                    type="password"
                    id="confirmPassword"
                    class="form-control"
                    formControlName="confirmPassword"
                    [class.is-invalid]="isPasswordFieldInvalid('confirmPassword') || passwordsDoNotMatch()">
                  @if (isPasswordFieldInvalid('confirmPassword')) {
                    <div class="invalid-feedback">Confirma la contraseña</div>
                  }
                  @if (passwordsDoNotMatch()) {
                    <div class="invalid-feedback d-block">Las contraseñas no coinciden</div>
                  }
                </div>
              </div>

              <hr class="my-4">

              <button 
                type="submit"
                class="btn btn-gradient"
                [disabled]="isSaving() || passwordForm.invalid || passwordsDoNotMatch()">
                @if (isSaving()) {
                  <span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
                  Actualizando...
                } @else {
                  <i class="bi bi-shield-check me-2" aria-hidden="true"></i>
                  Cambiar Contraseña
                }
              </button>
            </form>
          </div>

          <div class="card-modern p-4">
            <h5 class="fw-bold mb-3">Autenticación de Dos Factores</h5>
            <p class="text-muted">Agrega una capa extra de seguridad a tu cuenta</p>
            <button type="button" class="btn btn-outline-primary">
              <i class="bi bi-shield-plus me-2" aria-hidden="true"></i>
              Habilitar 2FA
            </button>
          </div>
        }

        <!-- TAB: PREFERENCES -->
        @if (activeTab() === 'preferences') {
          <div class="card-modern p-4" role="tabpanel" tabindex="0">
            <h4 class="fw-bold mb-4">Preferencias</h4>

            <div class="mb-4">
              <h6 class="fw-bold mb-3">Notificaciones</h6>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="emailNotif" checked>
                <label class="form-check-label" for="emailNotif">
                  Recibir notificaciones por email
                </label>
              </div>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="courseUpdates" checked>
                <label class="form-check-label" for="courseUpdates">
                  Actualizaciones de cursos
                </label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="marketing">
                <label class="form-check-label" for="marketing">
                  Ofertas y promociones
                </label>
              </div>
            </div>

            <hr>

            <div class="mb-4">
              <h6 class="fw-bold mb-3">Idioma</h6>
              <label for="languageSelect" class="visually-hidden">Seleccionar idioma</label>
              <select id="languageSelect" class="form-select">
                <option selected>Español</option>
                <option>English</option>
                <option>Português</option>
              </select>
            </div>

            <hr>

            <div>
              <h6 class="fw-bold mb-3 text-danger">Zona de Peligro</h6>
              <button type="button" class="btn btn-outline-danger">
                <i class="bi bi-trash me-2" aria-hidden="true"></i>
                Eliminar Cuenta
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>