<app-navbar></app-navbar>

<div class="course-viewer-page">
  @if (isLoading()) {
    <div class="d-flex align-items-center justify-content-center h-100-minus-nav">
      <app-loading-spinner [size]="60" message="Cargando curso..."></app-loading-spinner>
    </div>
  } @else if (course()) {
    <div class="viewer-container">
      
      <aside class="sidebar" [class.collapsed]="sidebarCollapsed()">
        <div class="sidebar-header">
          <h6 class="fw-bold mb-0 text-truncate">{{ course()!.title }}</h6>
          
          <button 
            type="button"
            class="btn btn-sm btn-link text-white"
            (click)="toggleSidebar()">
            
            <i class="bi" 
               [class.bi-chevron-left]="!sidebarCollapsed()" 
               [class.bi-chevron-right]="sidebarCollapsed()" 
               aria-hidden="true">
            </i>

            <span class="visually-hidden">
              {{ sidebarCollapsed() ? 'Expandir menú' : 'Colapsar menú' }}
            </span>
          </button>
        </div>

        <div class="sidebar-content">
          <div class="p-3 border-bottom">
            <div class="d-flex justify-content-between mb-2">
              <small>Progreso del curso</small>
              <small class="fw-bold">{{ courseProgress() }}%</small>
            </div>
            
            <div 
              class="progress progress-sm" 
              role="progressbar" 
              aria-label="Porcentaje completado del curso"
              [attr.aria-valuenow]="courseProgress()" 
              aria-valuemin="0" 
              aria-valuemax="100">
              
              <div 
                class="progress-bar bg-gradient" 
                [style.width.%]="courseProgress()">
              </div>
            </div>
          </div>

          <div class="content-list">
            @if (course()!.syllabus && course()!.syllabus.sections) {
              @for (section of course()!.syllabus.sections; track section.id; let sectionIndex = $index) {
                <div class="section-item">
                  
                  <button 
                    type="button"
                    class="section-header btn-reset w-100 text-start"
                    (click)="toggleSection(sectionIndex)"
                    [attr.aria-expanded]="expandedSections().includes(sectionIndex)">
                    
                    <div class="d-flex align-items-center gap-2">
                      <i class="bi" 
                         [class.bi-chevron-right]="!expandedSections().includes(sectionIndex)" 
                         [class.bi-chevron-down]="expandedSections().includes(sectionIndex)"
                         aria-hidden="true"></i>
                      <strong>{{ section.title }}</strong>
                    </div>
                    <small class="text-muted">
                      {{ getCompletedLessons(sectionIndex) }}/{{ section.lessons?.length || 0 }}
                    </small>
                  </button>

                  @if (expandedSections().includes(sectionIndex) && section.lessons) {
                    <div class="lessons-list">
                      @for (lesson of section.lessons; track lesson.id; let lessonIndex = $index) {
                        
                        <button 
                          type="button"
                          class="lesson-item btn-reset w-100 text-start"
                          [class.active]="isCurrentLesson(sectionIndex, lessonIndex)"
                          [class.completed]="isLessonCompleted(sectionIndex, lessonIndex)"
                          (click)="selectLesson(sectionIndex, lessonIndex)">
                          
                          <div class="d-flex align-items-center gap-2">
                            @if (isLessonCompleted(sectionIndex, lessonIndex)) {
                              <i class="bi bi-check-circle-fill text-success" aria-hidden="true"></i>
                            } @else {
                              <i class="bi bi-play-circle" aria-hidden="true"></i>
                            }
                            <span>{{ lesson.title }}</span>
                          </div>
                          <small class="text-muted">{{ lesson.duration }} min</small>
                        </button>
                      }
                    </div>
                  }
                </div>
              }
            }
          </div>
        </div>
      </aside>

      <main class="main-content">
        @if (currentLesson()) {
          <div class="video-container">
            @if (currentLesson()!.videoUrl) {
              <iframe
                [src]="getVideoUrl()"
                title="Reproductor de video de la lección" 
                frameborder="0"
                allowfullscreen
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
              </iframe>
            } @else {
              <div class="placeholder-video bg-dark text-white d-flex align-items-center justify-content-center">
                <div class="text-center">
                  <i class="bi bi-play-circle display-1 mb-3" aria-hidden="true"></i>
                  <p>Video no disponible</p>
                </div>
              </div>
            }
          </div>

          <div class="lesson-info p-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div class="flex-grow-1">
                <h1 class="h4 fw-bold mb-2">{{ currentLesson()!.title }}</h1>
                @if (currentLesson()!.description) {
                  <p class="text-muted">{{ currentLesson()!.description }}</p>
                }
              </div>
              <div class="d-flex gap-2">
                @if (!isLessonCompleted(currentSectionIndex(), currentLessonIndex())) {
                  <button 
                    type="button"
                    class="btn btn-success"
                    (click)="markAsCompleted()">
                    <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                    Marcar como Completada
                  </button>
                } @else {
                  <button type="button" class="btn btn-outline-success" disabled>
                    <i class="bi bi-check-circle-fill me-2" aria-hidden="true"></i>
                    Completada
                  </button>
                }
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <button 
                type="button"
                class="btn btn-outline-primary"
                [disabled]="!hasPreviousLesson()"
                (click)="previousLesson()">
                <i class="bi bi-chevron-left me-2" aria-hidden="true"></i>
                Anterior
              </button>

              <div class="text-center">
                <small class="text-muted">
                  Lección {{ currentLessonIndex() + 1 }} de {{ getTotalLessons() }}
                </small>
              </div>

              <button 
                type="button"
                class="btn btn-gradient"
                [disabled]="!hasNextLesson()"
                (click)="nextLesson()">
                Siguiente
                <i class="bi bi-chevron-right ms-2" aria-hidden="true"></i>
              </button>
            </div>
          </div>

          <div class="lesson-tabs">
            <ul class="nav nav-tabs px-4" role="tablist">
              <li class="nav-item" role="presentation">
                <button 
                  type="button"
                  class="nav-link"
                  role="tab"
                  [attr.aria-selected]="activeTab() === 'resources'"
                  [class.active]="activeTab() === 'resources'"
                  (click)="activeTab.set('resources')">
                  <i class="bi bi-file-earmark me-2" aria-hidden="true"></i>
                  Recursos
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button 
                  type="button"
                  class="nav-link"
                  role="tab"
                  [attr.aria-selected]="activeTab() === 'notes'"
                  [class.active]="activeTab() === 'notes'"
                  (click)="activeTab.set('notes')">
                  <i class="bi bi-journal-text me-2" aria-hidden="true"></i>
                  Mis Notas
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button 
                  type="button"
                  class="nav-link"
                  role="tab"
                  [attr.aria-selected]="activeTab() === 'qna'"
                  [class.active]="activeTab() === 'qna'"
                  (click)="activeTab.set('qna')">
                  <i class="bi bi-chat-dots me-2" aria-hidden="true"></i>
                  Preguntas
                </button>
              </li>
            </ul>

            <div class="tab-content p-4">
              @if (activeTab() === 'resources') {
                <div class="resources-tab" role="tabpanel">
                  <h6 class="fw-bold mb-3">Recursos de la Lección</h6>
                  @if (currentLesson()!.resources && currentLesson()!.resources.length > 0) {
                    <div class="list-group">
                      @for (resource of currentLesson()!.resources; track $index) {
                        <a 
                          [href]="resource.url" 
                          target="_blank"
                          class="list-group-item list-group-item-action">
                          <i class="bi bi-file-earmark-pdf me-2" aria-hidden="true"></i>
                          {{ resource.title }}
                        </a>
                      }
                    </div>
                  } @else {
                    <p class="text-muted">No hay recursos disponibles para esta lección</p>
                  }
                </div>
              }

              @if (activeTab() === 'notes') {
                <div class="notes-tab" role="tabpanel">
                  <h6 class="fw-bold mb-3">Tus Notas Personales</h6>
                  <label for="lessonNotes" class="visually-hidden">Tus notas</label>
                  <textarea 
                    id="lessonNotes"
                    class="form-control mb-3"
                    rows="5"
                    placeholder="Escribe tus notas aquí..."
                    [(ngModel)]="lessonNotes">
                  </textarea>
                  <button type="button" class="btn btn-gradient" (click)="saveNotes()">
                    <i class="bi bi-save me-2" aria-hidden="true"></i>
                    Guardar Notas
                  </button>
                </div>
              }

              @if (activeTab() === 'qna') {
                <div class="qna-tab" role="tabpanel">
                  <h6 class="fw-bold mb-3">Preguntas y Respuestas</h6>
                  <p class="text-muted">Funcionalidad de Q&A próximamente...</p>
                </div>
              }
            </div>
          </div>
        } @else {
          <div class="d-flex align-items-center justify-content-center h-100">
            <div class="text-center text-muted">
              <i class="bi bi-play-circle display-1" aria-hidden="true"></i>
              <p class="mt-3">Selecciona una lección para comenzar</p>
            </div>
          </div>
        }
      </main>
    </div>
  } @else {
    <div class="d-flex align-items-center justify-content-center h-100-minus-nav">
      <div class="text-center">
        <i class="bi bi-exclamation-triangle display-1 text-warning" aria-hidden="true"></i>
        <h4 class="mt-4">Curso no encontrado</h4>
        <p class="text-muted">No tienes acceso a este curso</p>
        <a routerLink="/student/my-courses" class="btn btn-gradient mt-3">
          Ver Mis Cursos
        </a>
      </div>
    </div>
  }
</div>