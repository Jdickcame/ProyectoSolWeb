<app-navbar></app-navbar>

<div class="course-viewer-page">
  @if (isLoading()) {
    <div class="d-flex align-items-center justify-content-center h-100-minus-nav">
      <app-loading-spinner [size]="60" message="Cargando contenido..."></app-loading-spinner>
    </div>
  } @else if (course()) {
    <div class="viewer-container">
      
      <!-- SIDEBAR (Temario) -->
      <aside class="sidebar" [class.collapsed]="sidebarCollapsed()">
        <div class="sidebar-header">
          <h6 class="fw-bold mb-0 text-truncate flex-grow-1">{{ course()!.title }}</h6>
          
          <!-- Botón para CERRAR el menú (Solo visible cuando está abierto) -->
          @if (!sidebarCollapsed()) {
            <button 
              type="button"
              class="btn btn-sm btn-link text-white ms-2"
              (click)="toggleSidebar()"
              title="Ocultar menú">
              <i class="bi bi-chevron-left" aria-hidden="true"></i>
            </button>
          }
        </div>

        <!-- Contenido del Sidebar (Solo visible si NO está colapsado) -->
        <div class="sidebar-content" [class.d-none]="sidebarCollapsed()">
          
          <!-- Lógica de Progreso / Edición -->
          @if (isOnlyStudent()) {
              <div class="p-3 border-bottom">
                  <div class="d-flex justify-content-between mb-2">
                      <small>Progreso del curso</small>
                      <small class="fw-bold">{{ courseProgress() }}%</small>
                  </div>
                  <div class="progress progress-sm" role="progressbar" [attr.aria-valuenow]="courseProgress()" aria-valuemin="0" aria-valuemax="100">
                      <div class="progress-bar bg-gradient" [style.width.%]="courseProgress()"></div>
                  </div>
              </div>
          } @else if (isCourseOwner()) {
              <div class="p-3 border-bottom">
                  <div class="alert alert-warning p-2 small mb-2 text-center fw-semibold">
                      Modo Instructor
                  </div>
                  <a [routerLink]="['/teacher/course-form', course()!.id]" class="btn btn-sm btn-warning w-100">
                      <i class="bi bi-pencil-square me-2"></i> Editar Lecciones
                  </a>
              </div>
          }

          <!-- Lista de Secciones -->
          <div class="content-list">
            @if (course()!.sections || course()!.syllabus.sections) {
              @for (section of (course()!.sections || course()!.syllabus.sections); track section.id) {
                <div class="section-item">
                  <button 
                    type="button"
                    class="section-header btn-reset w-100 text-start"
                    (click)="toggleSection(section.id)"
                    [attr.aria-expanded]="isSectionExpanded(section.id)">
                    <div class="d-flex align-items-center gap-2">
                      <i class="bi" 
                         [class.bi-chevron-right]="!isSectionExpanded(section.id)" 
                         [class.bi-chevron-down]="isSectionExpanded(section.id)"
                         aria-hidden="true"></i>
                      <strong>{{ section.title }}</strong>
                    </div>
                  </button>

                  @if (isSectionExpanded(section.id)) {
                    <div class="lessons-list">
                      @if (section.lessons && section.lessons.length > 0) {
                        @for (lesson of section.lessons; track lesson.id) {
                          <button 
                            type="button"
                            class="lesson-item btn-reset w-100 text-start"
                            [class.active]="isCurrentLesson(lesson.id)"
                            [class.completed]="isLessonCompleted(lesson.id)"
                            (click)="selectLesson(lesson)">
                            <div class="d-flex align-items-center gap-2">
                              @if (isLessonCompleted(lesson.id)) {
                                <i class="bi bi-check-circle-fill text-success" aria-hidden="true"></i>
                              } @else {
                                <i class="bi bi-play-circle" aria-hidden="true"></i>
                              }
                              <span class="text-truncate">{{ lesson.title }}</span>
                            </div>
                            <small class="text-muted ms-auto">{{ lesson.duration }} min</small>
                          </button>
                        }
                      } @else {
                        <div class="p-3 text-center text-muted fst-italic small bg-light">
                          <i class="bi bi-inbox me-1"></i> No hay lecciones
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            }
          </div>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main-content position-relative">
        
        <!-- BOTÓN FLOTANTE PARA ABRIR EL MENÚ (Solo visible cuando está colapsado) -->
        @if (sidebarCollapsed()) {
          <button 
            class="btn btn-dark btn-sm position-absolute top-0 start-0 m-3 shadow" 
            style="z-index: 1000;"
            (click)="toggleSidebar()"
            title="Mostrar temario">
            <i class="bi bi-list me-2"></i> Temario
          </button>
        }

        @if (currentLesson()) {
          <!-- Reproductor -->
          @if (currentLesson()!.videoUrl) {
            <div class="video-wrapper bg-black">
              <div class="video-container mx-auto">
                <iframe
                  [src]="safeVideoUrl()"
                  title="Reproductor" 
                  frameborder="0"
                  allowfullscreen
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                </iframe>
              </div>
            </div>
          }

          <!-- Info de la Lección -->
          <div class="lesson-info p-4">
            <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-3">
              <div class="flex-grow-1">
                <h1 class="h4 fw-bold mb-2">{{ currentLesson()!.title }}</h1>
                @if (currentLesson()!.content) {
                  <p class="lead text-muted">{{ currentLesson()!.content }}</p>
                }
              </div>
              
              @if (isOnlyStudent()) {
                  <div class="d-flex gap-2">
                      @if (!isLessonCompleted(currentLesson()!.id)) {
                          <button class="btn btn-success" (click)="markAsCompleted()">
                              <i class="bi bi-check-circle me-2"></i> Marcar como Completada
                          </button>
                      } @else {
                          <button type="button" class="btn btn-outline-success" disabled>
                              <i class="bi bi-check-circle-fill me-2"></i> Completada
                          </button>
                      }
                  </div>
              }
            </div>

            <!-- Navegación -->
            <div class="d-flex justify-content-between align-items-center mt-4 border-top pt-3">
              <button 
                type="button"
                class="btn btn-outline-primary"
                [disabled]="!hasPreviousLesson()"
                (click)="previousLesson()">
                <i class="bi bi-chevron-left me-2"></i> Anterior
              </button>

              <button 
                type="button"
                class="btn btn-gradient"
                [disabled]="!hasNextLesson()"
                (click)="nextLesson()">
                Siguiente <i class="bi bi-chevron-right ms-2"></i>
              </button>
            </div>
          </div>

          <!-- Pestañas -->
          <div class="lesson-tabs mt-2">
            <ul class="nav nav-tabs px-4" role="tablist">
              <li class="nav-item">
                <button 
                  class="nav-link active" 
                  (click)="activeTab.set('resources')">
                  <i class="bi bi-file-earmark me-2"></i> Recursos
                </button>
              </li>
            </ul>
            <div class="tab-content p-4 bg-white">
              @if (activeTab() === 'resources') {
                <div class="resources-tab">
                  <h6 class="fw-bold mb-3">Recursos de la Lección</h6>
                  <!-- Aquí iría la lista de recursos si el backend los envía -->
                  <p class="text-muted fst-italic">No hay recursos adjuntos.</p>
                </div>
              }
            </div>
          </div>

        } @else {
          <div class="d-flex align-items-center justify-content-center h-100 text-muted">
            <div class="text-center">
              <i class="bi bi-collection-play display-1 mb-3"></i>
              <p>Selecciona una lección del menú para comenzar</p>
            </div>
          </div>
        }
      </main>
    </div>
  } @else {
    <div class="d-flex align-items-center justify-content-center h-100-minus-nav">
      <div class="text-center">
        <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
        <h4 class="mt-4">Acceso Denegado</h4>
        <p class="text-muted">No tienes acceso a este curso.</p>
        <a routerLink="/student/my-courses" class="btn btn-primary mt-3">Volver</a>
      </div>
    </div>
  }
</div>