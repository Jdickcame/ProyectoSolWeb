<app-navbar></app-navbar>

<div class="messages-page bg-light min-vh-100 py-5">
  <div class="container">
    <h2 class="fw-bold text-dark" >Mis Conversaciones</h2>

    @if (isLoading()) {
      <div class="text-center py-5">
        <app-loading-spinner [size]="50"></app-loading-spinner>
      </div>
    } 
    @else if (conversations().length > 0) {
      <div class="card-modern">
        <div class="list-group list-group-flush">
          @for (conv of conversations(); track conv.senderId) {
            <button 
              type="button" 
              class="list-group-item list-group-item-action p-4 d-flex gap-3 align-items-center"
              (click)="openConversation(conv)">
              
              <!-- Avatar -->
              <div class="bg-white border text-primary rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 shadow-sm" 
                   style="width: 50px; height: 50px;">
                <span class="fw-bold fs-5">{{ conv.senderName.charAt(0) }}</span>
              </div>

              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <h6 class="mb-0 text-dark fw-bold">{{ conv.senderName }} {{ conv.senderSurname }}</h6>
                  <small class="text-muted">{{ conv.lastMessageDate | date:'shortDate' }}</small>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <p class="text-muted small mb-0 text-truncate" style="max-width: 500px;">
                    {{ conv.messages[0].content }} 
                    <span class="fst-italic text-secondary">({{ conv.messages.length }} mensajes)</span>
                  </p>
                  
                  @if (conv.unreadCount > 0) {
                    <span class="badge bg-danger rounded-pill">{{ conv.unreadCount }} nuevos</span>
                  }
                </div>
              </div>
            </button>
          }
        </div>
      </div>
    } 
    @else {
      <div class="text-center py-5 text-muted">
        <i class="bi bi-chat-square-text display-1 opacity-25"></i>
        <h4 class="mt-3">No tienes mensajes</h4>
      </div>
    }
  </div>
</div>

<!-- MODAL TIPO CHAT -->
@if (selectedConversation()) {
  <div class="modal-backdrop fade show"></div>
  <div class="modal fade show d-block" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="height: 80vh;"> <!-- Altura fija para chat -->
        
        <!-- Header Chat -->
        <div class="modal-header bg-light">
          <h5 class="modal-title fw-bold">
            Chat con {{ selectedConversation()!.senderName }}
          </h5>
          <button type="button" class="btn-close" (click)="closeConversation()"></button>
        </div>
        
        <!-- Body Chat (Scrollable) -->
        <div class="modal-body bg-white d-flex flex-column" style="overflow-y: auto; background-color: #f8f9fa !important;">
          <!-- Iteramos en reverso para que el más nuevo quede abajo si usamos flex-column-reverse, 
               pero aquí iteraremos normal y los mostraremos como bloques -->
          
          @for (msg of selectedConversation()!.messages; track msg.id) {
            <div class="d-flex flex-column align-items-start mb-3">
              <div class="card border-0 shadow-sm" style="max-width: 80%; border-radius: 15px; border-top-left-radius: 2px;">
                <div class="card-body p-3">
                   <p class="mb-1">{{ msg.content }}</p>
                   <small class="text-muted" style="font-size: 0.7rem;">
                     {{ msg.sentAt | date:'short' }}
                   </small>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Footer (Input) -->
        <div class="modal-footer bg-light">
          <div class="input-group">
            <textarea 
                class="form-control" 
                rows="1" 
                [(ngModel)]="replyContent" 
                placeholder="Escribe un mensaje..."></textarea>
            <button 
                class="btn btn-primary" 
                (click)="sendReply()"
                [disabled]="!replyContent.trim() || isSending()">
                <i class="bi bi-send-fill"></i>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>
}

<app-footer></app-footer>